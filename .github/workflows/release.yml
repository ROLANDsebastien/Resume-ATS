name: Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version number (e.g., 1.0.0)"
                required: true
                type: string

jobs:
    build-and-release:
        runs-on: macos-latest
        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Build App
              run: |
                  xcodebuild -scheme Resume-ATS \
                    -configuration Release \
                    -derivedDataPath build \
                    -destination 'platform=macOS' \
                    CODE_SIGN_IDENTITY="" \
                    CODE_SIGNING_REQUIRED=NO \
                    CODE_SIGNING_ALLOWED=NO \
                    build

            - name: Create ZIP
              run: |
                  cd build/Build/Products/Release
                  zip -r Resume-ATS.zip Resume-ATS.app
                  mv Resume-ATS.zip $GITHUB_WORKSPACE/

            - name: Get version
              id: get_version
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    echo "VERSION=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
                  else
                    echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
                  fi

            - name: Create Release Notes
              id: create_notes
              run: |
                  cat > release_notes.md << 'EOF'
                  ## Installation

                  1. Download `Resume-ATS.zip`
                  2. Extract the file
                  3. Move `Resume-ATS.app` to your Applications folder
                  4. On first launch, right-click > Open (for unsigned apps)

                  ## Installation (Francais)

                  1. Telechargez `Resume-ATS.zip`
                  2. Extrayez le fichier
                  3. Deplacez `Resume-ATS.app` dans votre dossier Applications
                  4. Au premier lancement, faites clic-droit > Ouvrir (pour les apps non signees)

                  ## What's New
                  EOF

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.get_version.outputs.VERSION }}
                  name: "Resume-ATS ${{ steps.get_version.outputs.VERSION }}"
                  body_path: release_notes.md
                  files: Resume-ATS.zip
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
